# coding: utf-8

#
# Copyright © 2017 weirdgiraffe <giraffe@cyberzoo.xyz>
#
# Distributed under terms of the MIT license.
#
import json
import os
import pytest
from pytest_check import check
import pprint
import seasonvar.parser as parser


def assetpath(path):
    return os.path.join(os.path.dirname(__file__), 'assets', path)


def test_decode_episode_file_to_url():
    check.equal('http://data08-cdn.datalock.ru/fi2lm/0b621d3fbcbe74cfeb0fbe93d5dc1512/7f_AniMaunt.-.[Animaunt].Voshozhdenie.v.teni.-.Kage.no.Jitsuryokusha.ni.Naritakute.-.01.seriya.mnogogolosaya.ozvuchka.a1.26.10.22.mp4',
                parser._decode_episode_file_to_url('#2aHR0cDovL2RhdGEwOC1jZG4uZGF0YWxvY2sucnUvZmkybG0vMGI2MjFkM2ZiY2JlNzRjZmViMGZiZTkzZDVkYzE1MTIvN2ZfQW5pTWF1bnQuLS5bQW5pbWF1bnRdLlZvc2hvemhkZW5pZS52LnRlbmkuLS5LYWdlLm5vLkppdHN1cnlva3VzaGEubmkuTmFyaXRha3V0ZS4tLjAxLnNlcml5YS5tbm9nb2dvbG9zYXlhLm96dnVjaGthLmExLjI2LjEwLjIyLm1wNA=='))

    check.equal('http://data11-cdn.datalock.ru/fi2lm/0b621d3fbcbe74cfeb0fbe93d5dc1512/7f_Detstvo.Sheldona.KB.S6E02.a1.28.10.22.mp4',
                parser._decode_episode_file_to_url('#2aHR0cDovL2RhdGExMS1jZG4uZGF0YWxvY2sucnUvZmkybG0vMGI2MjFkM2ZiY2JlNzRjZmViMGZiZTkzZDVkYzE1MTIvN2ZfRGV0c3R2by5TaGVsZG9uYS5LQi5TNkUwMi5hMS4yOC4xMC\/\/b2xvbG8=4yMi5tcDQ='))


@pytest.mark.parametrize('asset, expected_dates', [
    ('dayblock_single.html', ['03.04.2017']),
    ('dayblock_multiple.html', ['03.04.2017', '02.04.2017'])
])
def test_parse_main_page_dayblock(asset, expected_dates):
    with open(assetpath(asset)) as f:
        dates = []
        for d, content in parser._main_page_dayblocks(f.read()):
            dates.append(d)
            assert len(content) > 0
        assert dates == expected_dates


@pytest.mark.parametrize('asset, expected_items', [
    ('dayblock_single.html', [
        {
            'changes': '(6 сезон) 11 серия (Amedia)',
            'name': 'Родина',
            'url': '/serial-14903-Rodina-00006-sezon.html'
        },
        {
            'changes': '10 серия (Котова)',
            'name': 'До самой смерти',
            'url': '/serial-14996-Do_samoj_smerti.html'
        },
        {
            'changes': '(3 сезон) 10 серия (Amedia)',
            'name': 'Игроки / Футболисты',
            'url': '/serial-15971-Igroki--03-sezon.html'
        }]),
])
def test_parse_dayblock_items(asset, expected_items):
    with open(assetpath(asset)) as f:
        html = f.read()
        dayblocks = [c for x, c in parser._main_page_dayblocks(html)]
        assert len(dayblocks) == 1
        assert len(dayblocks[0]) > 0
        items = [x for x in parser._main_page_dayblock_items(dayblocks[0])]
        assert len(items) == len(expected_items)
        for n, item in enumerate(items):
            assert item == expected_items[n]


@pytest.mark.parametrize('asset, expected_suggestions', [
    ('search-no-results.json', 0),
    ('search-rick-and-morty.json', 31),
])
def test_parse_search_response(asset, expected_suggestions):
    with open(assetpath(asset)) as f:
        items = [x for x in parser.search_items(json.loads(f.read()))]
        assert len(items) == expected_suggestions
        for i in items:
            assert i['url'] is not None
            print(i)


def test_parse_seasons():
    asset = 'serial-example-seasonlist.html'
    expected_count = 4
    with open(assetpath(asset)) as f:
        seasons = list(parser.seasons(f.read()))
        assert len(seasons) == expected_count


def test_parse_player_params():
    asset = 'serial-example-playerparams.html'
    with open(assetpath(asset)) as f:
        params = parser.player_params(f.read())
        assert params


@pytest.mark.parametrize('asset, expected_count', [
    ('player-response-example-single.html', 1),
    ('player-response-example-multi.html', 7),
])
def test_parse_playlists(asset, expected_count):
    with open(assetpath(asset)) as f:
        playlists = list(parser.playlists(f.read()))
        assert len(playlists) == expected_count
        tr = set([])
        pprint.pprint(playlists)
        for pl in playlists:
            assert pl['tr'] not in tr
            tr.add(pl['tr'])


@pytest.mark.parametrize('asset, expected_count', [
    ('playlist.json', 8),
])
def test_parse_episodes(asset, expected_count):
    with open(assetpath(asset)) as f:
        items = list(parser.episodes(json.loads(f.read())))
        assert len(items) == expected_count
        for i in items:
            assert 'name' in i
            assert 'name' != ''
            assert 'url' in i
            assert 'url' != ''
