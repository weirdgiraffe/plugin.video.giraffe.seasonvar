# coding: utf-8

#
# Copyright © 2017 weirdgiraffe <giraffe@cyberzoo.xyz>
#
# Distributed under terms of the MIT license.
#
from __future__ import unicode_literals
import seasonvar.mainpage as mainpage
import seasonvar.search as search
import xbmc, re
import xbmcgui
import xbmcplugin
from addon.common import Addon, getLogger, show_notification
from datetime import datetime, timedelta
from seasonvar.requester import NetworkError
from seasonvar.show import Show
from seasonvar.season import Season


addon = Addon('plugin.video.giraffe.seasonvar')
logger = getLogger('plugin.video.giraffe.seasonvar')


def li(name, **kwargs):
    thumb = kwargs.get('thumb')
    playable = kwargs.get('playable')
    li = xbmcgui.ListItem(name)
    if thumb is not None:
        li.setArt(thumb)
        # it is sayed that both of these methods are deprecated
        # see: http://kodi.wiki/view/Jarvis_API_changes
        # but only these methods actually works with Jarvis
        li.setIconImage(thumb)
        li.setThumbnailImage(thumb)
    if playable is not None:
        li.setProperty('IsPlayable', str(playable))
    return li


def add_directory_to_list(dirname, url, **kwargs):
    items_count = kwargs.get('items_count')
    litem = li(dirname, **kwargs)
    if items_count:
        ret = xbmcplugin.addDirectoryItem(addon.handler,
                                          url, litem,
                                          True, items_count)
    else:
        ret = xbmcplugin.addDirectoryItem(addon.handler,
                                          url, litem,
                                          True)
    if not ret:
        logger.error('failed to add {0} directory item'.format(dirname))


def add_item_to_list(name, url, **kwargs):
    litem = li(name, **kwargs)
    ret = xbmcplugin.addDirectoryItem(addon.handler, url, litem, False)
    if not ret:
        logger.error('failed to add {0} item'.format(name))


def list_end():
    xbmcplugin.endOfDirectory(addon.handler)


def screen_start(args):
    date = datetime.today()
    for offset in range(7):
        datestr = date.strftime('%d.%m.%Y')
        add_directory_to_list(
            datestr,
            addon.make_url({'action': 'screen_date',
                            'date': datestr})
        )
        date -= timedelta(days=1)
    add_directory_to_list(
        '[COLOR FFFFD700]поиск[/COLOR]',
        addon.make_url({'action': 'screen_search'})
    )
    list_end()


def screen_date(args):
    date = args.get('date')
    if date is None:
        logger.error(
            'screen_date: "date" is missing or malformed: {0}'.format(args))
        return

    date_items = list(mainpage.dayitems(date))

    if len(date_items) == 0:
        logger.error('screen_date: date {0} not found'.format(date))
        return

    for item in date_items:
        print(item['url'])
        s = Season(item['url'], None, None)
        displayed_name = '{0} [COLOR FFFFD700]{1}[/COLOR]'.format(
            item['name'],
            item['changes'])

        add_directory_to_list(
            displayed_name,
            addon.make_url({'action': 'screen_episodes', 'url': item['url']}),
            thumb=s.thumb)
    list_end()

sre = re.compile(r'(\(.*?\))',re.UNICODE)


def screen_episodes(args):
    url = args.get('url')
    name = sre.sub('', args.get('name','').decode('utf-8')).strip()
    if url is None:
        logger.error('screen_episodes: "url" arg is missing {0}'.format(args))
        return

    series = Show(url)
    seasons_count = len(series.seasons)
    season = series.current_season
    if seasons_count > 1:
        add_directory_to_list(
            '[COLOR FFFFD700]{serial} [/COLOR]'
            '[COLOR green] Сезон [/COLOR] {sn} / {sc}'.format(serial=name, sn=season.number, sc=seasons_count),
            addon.make_url({'action': 'screen_seasons', 'url': url, 'serialname': name.encode('utf-8')}),
            items_count=len(series.seasons)
        )
    for episode in season.episodes():
        add_item_to_list(
            episode['name'],
            addon.make_url({'action': 'play', 'url': episode['url']}),
            thumb=episode['thumb'],
            playable=True
        )
    list_end()


def screen_seasons(args):
    url = args.get('url')
    serialname = args.get('serialname', '').decode('utf-8')
    if url is None:
        logger.error('screen_episodes: "url" arg is missing {0}'.format(args))
        return

    series = Show(url)
    name = u'[COLOR FF0FF000]{name}[/COLOR]'.format(name=serialname)
    add_item_to_list(name,addon.make_url({}),playable=False)
    for season in series.seasons:
        if season.number == series.current_season.number:
            prefix = u'* '
        else:
            prefix = u''
        add_directory_to_list(
            u'{0}сезон {1}'.format(prefix, season.number),
            addon.make_url({'action': 'screen_episodes', 'url': season.url, 'name': serialname.encode('utf-8')}),
            thumb=season.thumb
        )
    list_end()


def play(args):
    url = args.get('url')
    if url is None:
        logger.error('play: "url" arg is missing {0}'.format(args))
        return
    item = xbmcgui.ListItem(path=url)
    item.setProperty('IsPlayable', 'true')
    xbmcplugin.setResolvedUrl(addon.handler, True, item)


def get_user_input(heading):
    keyboard = xbmc.Keyboard('', heading, False)
    keyboard.doModal()
    if (keyboard.isConfirmed()):
        return keyboard.getText()
    else:
        return ''


def display_search_items(term):
    for item in search.searchitems(term):
        if item['url'] is not None:
            #print(item)
            s = Season(item['url'], None, None)
            add_directory_to_list(
                item['name'],
                addon.make_url({'action': 'screen_episodes',
                                'url': item['url'], 
                                'name': item['name'].encode('utf-8')}),
                thumb=s.thumb
            )
    list_end()

def screen_search(args):
    term = get_user_input('Что искать?')
    display_search_items(term)


def main():
    print(addon.args)
    if 'action' in addon.args:
        action = addon.args['action']
    else:
        action = 'screen_start'

    try:
        {'screen_start': screen_start,
         'screen_date': screen_date,
         'screen_episodes': screen_episodes,
         'screen_seasons': screen_seasons,
         'screen_search': screen_search,
         'play': play,
         }[action](addon.args)
    except NetworkError:
        show_notification('Network error',
                          'check your connection',
                          addon.icon)
        logger.error('network error')
    except KeyError:
        logger.error('wrong action {0}'.format(addon.args['action']))
